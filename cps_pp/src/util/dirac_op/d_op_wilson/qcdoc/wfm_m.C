#include <util/wfm.h>
#include "wfm_internal.h"
CPS_START_NAMESPACE

/*--------------------------------------------------------------------------*/
/* wilson_m:                                                                */
/*--------------------------------------------------------------------------*/

void wfm::m(Float *chi, 
	    Float *u, 
	    Float *psi, 
	    Float kappa)
{
/*--------------------------------------------------------------------------*/
/* Initializations                                                          */
/*--------------------------------------------------------------------------*/
  int len         =  vol * ND;
  Float  mkappasq = -kappa*kappa;

/*--------------------------------------------------------------------------*/
/* Dslash_E0                                                                */
/*--------------------------------------------------------------------------*/
  dslash(spinor_tmp, u, psi, 1, 0);

/*--------------------------------------------------------------------------*/
/* Dslash_0E                                                                */
/*--------------------------------------------------------------------------*/
  dslash(chi, u, spinor_tmp, 0, 0);

/*--------------------------------------------------------------------------*/
/* 1_OO - kappa^2 * Dslash_0E * Dslash_E0                                   */
/*--------------------------------------------------------------------------*/
  xaxpy(&mkappasq,chi,psi,len);
  DiracOp::CGflops += vol*24*2;
}


/*--------------------------------------------------------------------------*/
/* wfm::mdag:                                                             */
/*--------------------------------------------------------------------------*/
void wfm::mdag(Float *chi, 
	       Float *u, 
	       Float *psi, 
	       Float kappa)
{

/*--------------------------------------------------------------------------*/
/* Initializations                                                          */
/*--------------------------------------------------------------------------*/
  int        len = vol * ND;
  Float mkappasq = -kappa*kappa;

/*--------------------------------------------------------------------------*/
/* DslashDag_E0                                                             */
/*--------------------------------------------------------------------------*/
  dslash(spinor_tmp, u, psi, 1, 1);

/*--------------------------------------------------------------------------*/
/* DslashDag_0E                                                             */
/*--------------------------------------------------------------------------*/
  dslash(chi, u, spinor_tmp, 0, 1);

/*--------------------------------------------------------------------------*/
/* [1_OO - kappa * DslashDag_0E * DslashDag_E0] ]                           */
/*--------------------------------------------------------------------------*/
  xaxpy(&mkappasq,chi,psi,len);
#if 0
 for(int i=0;i<len*6;i++){
   printf("chi[%d]=%e psi[%d]=%e\n",i,chi[i],i,psi[i]);
   chi[i] = psi[i] -kappa*kappa*chi[i];
 }
#endif
  DiracOp::CGflops += vol*24*2;
}

void wfm::mdagm(Float *chi, 
		Float *u, 
		Float *psi, 
		Float *mp_sq_p,
		Float kappa)
{

/*--------------------------------------------------------------------------*/
/* Initializations                                                          */
/*--------------------------------------------------------------------------*/
  int len =  vol *ND;
  Float *tmp1 = spinor_tmp;
  Float *tmp2 = tmp1 + SPINOR_SIZE * vol ;
  Float sum;
  Float mkappasq = -kappa*kappa;

/*--------------------------------------------------------------------------*/
/* Dslash_E0                                                                */
/*--------------------------------------------------------------------------*/
  dslash(tmp1, u, psi, 1, 0);

/*--------------------------------------------------------------------------*/
/* Dslash_0E                                                                */
/*--------------------------------------------------------------------------*/
  dslash(tmp2, u, tmp1, 0, 0);

/*--------------------------------------------------------------------------*/
/* 1_OO - kappa^2 * Dslash_0E * Dslash_E0                                   */
/*--------------------------------------------------------------------------*/
  if(mp_sq_p != 0) {
    xaxpy_norm(&mkappasq,tmp2,psi,len,mp_sq_p);
    DiracOp::CGflops += vol*24*4;
  } else {
    xaxpy(&mkappasq,tmp2,psi,len);
    DiracOp::CGflops += vol*24*2;
  }

/*--------------------------------------------------------------------------*/
/* DslashDag_E0                                                             */
/*--------------------------------------------------------------------------*/
  dslash(tmp1, u, tmp2, 1, 1);

/*--------------------------------------------------------------------------*/
/* DslashDag_0E                                                             */
/*--------------------------------------------------------------------------*/
  dslash(chi, u, tmp1, 0, 1);

/*--------------------------------------------------------------------------*/
/* [1_OO - kappa * DslashDag_0E * DslashDag_E0] *                           */
/*                                 [1_OO - kappa^2 * Dslash_0E * Dslash_E0] */
/*--------------------------------------------------------------------------*/
  xaxpy(&mkappasq,chi,tmp2,len);
  DiracOp::CGflops += vol*24*2;
}


CPS_END_NAMESPACE


